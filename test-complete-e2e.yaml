apiVersion: core.oam.dev/v1beta1
kind: Application
metadata:
  name: complete-e2e-test
  namespace: default
  labels:
    test-type: "complete-end-to-end"
    created-by: "claude-code"
    version: "all-components"
  annotations:
    description: "Complete E2E test with all three component types in unified repository"
    test-purpose: "Verify webservice, realtime-platform, and rasa-chatbot work together"
    expected-outcome: "3 Knative services, 3 microservices in folder, 2 GitHub Actions workflows"
spec:
  components:
  
  # 1. Standard Python/FastAPI WebService
  - name: user-service
    type: webservice
    properties:
      image: socrates12345/user-service:latest
      port: 8080
      language: python           # â† Triggers ApplicationClaim â†’ onion-architecture-template
      framework: fastapi
      repository: complete-healthcare-platform
      
  # 2. Real-time Streaming Platform  
  - name: analytics-platform
    type: realtime-platform
    properties:
      database: postgres
      visualization: metabase
      iot: true
      language: python          # â† Triggers Argo Workflow â†’ ApplicationClaim â†’ onion-architecture-template
      framework: fastapi
      repository: complete-healthcare-platform
      
  # 3. RASA Chatbot (Dual-Container Pattern)
  - name: support-chat
    type: rasa-chatbot
    properties:
      rasaImage: "socrates12345/support-chat-rasa:latest"
      actionsImage: "socrates12345/support-chat-actions:latest"
      enableIstioGateway: true
      language: rasa            # â† Triggers ApplicationClaim â†’ chat-template (3-tier Docker)
      framework: chatbot
      repository: complete-healthcare-platform
      
---
# COMPLETE E2E SUCCESS CRITERIA:
# 
# ğŸ—ï¸ UNIFIED REPOSITORY STRUCTURE:
# 1. âœ… Single AppContainer: https://github.com/shlapolosa/complete-healthcare-platform
# 2. âœ… Single AppContainer GitOps: https://github.com/shlapolosa/complete-healthcare-platform-gitops
# 3. âœ… Repository structure matches README:
#    â”œâ”€â”€ microservices/
#    â”‚   â”œâ”€â”€ user-service/          â† Python/FastAPI (comprehensive-gitops.yml)
#    â”‚   â”œâ”€â”€ support-chat/          â† RASA chatbot (chat-gitops.yml)  
#    â”‚   â””â”€â”€ analytics-platform/    â† Python/FastAPI + realtime (comprehensive-gitops.yml)
#    â”œâ”€â”€ .github/workflows/
#    â”‚   â”œâ”€â”€ comprehensive-gitops.yml   â† Handles Python services
#    â”‚   â””â”€â”€ chat-gitops.yml           â† Handles RASA services (3-tier builds)
#    â””â”€â”€ Infrastructure: PostgreSQL, Redis, Kafka, MQTT, Metabase
#
# ğŸš€ KNATIVE SERVICES:
# 4. âœ… user-service (webservice) â†’ image: socrates12345/user-service:latest
# 5. âœ… analytics-platform-realtime-service â†’ image: socrates12345/analytics-platform:latest
# 6. âœ… support-chat-rasa â†’ image: socrates12345/support-chat-rasa:latest
# 7. âœ… support-chat-actions â†’ image: socrates12345/support-chat-actions:latest
#
# ğŸ”„ INFRASTRUCTURE COMPONENTS:
# 8. âœ… PostgreSQL database deployed and healthy
# 9. âœ… Redis cache deployed and healthy  
# 10. âœ… Kafka + MQTT + Lenses + Metabase (from realtime-platform)
# 11. âœ… Database and cache secrets created
#
# ğŸ” CONDITIONAL LOGIC VERIFICATION:
# 12. âœ… Chat-repo-creator skips for user-service and analytics-platform (not RASA)
# 13. âœ… Chat-repo-creator processes support-chat (is RASA service)
# 14. âœ… Parameter mapping: APP_CONTAINER=complete-healthcare-platform for all services
# 15. âœ… NO separate service-specific repositories created
#
# ğŸ”§ GITOPS VERIFICATION:
# 16. âœ… GitOps manifests in complete-healthcare-platform-gitops/manifests/
# 17. âœ… ConfigMaps for all three services created
# 18. âœ… ArgoCD can discover and deploy all services
#
# VERIFICATION COMMANDS:
# kubectl get ksvc | grep -E "(user-service|analytics-platform|support-chat)"
# kubectl get applicationclaim | grep -E "(user-service|analytics-platform|support-chat)"
# kubectl get appcontainerclaim complete-healthcare-platform
# curl -s https://api.github.com/repos/shlapolosa/complete-healthcare-platform/contents/microservices
# curl -s https://api.github.com/repos/shlapolosa/complete-healthcare-platform/contents/.github/workflows
# kubectl logs job/user-service-chat-repo-creator
# kubectl logs job/analytics-platform-chat-repo-creator  
# kubectl logs job/support-chat-chat-repo-creator
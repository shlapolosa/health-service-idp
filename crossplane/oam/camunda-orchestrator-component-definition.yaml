---
# Camunda Orchestrator ComponentDefinition
# Orchestrates microservices workflows using Camunda 8 with event-driven patterns
apiVersion: core.oam.dev/v1beta1
kind: ComponentDefinition
metadata:
  name: camunda-orchestrator
  annotations:
    definition.oam.dev/description: "Camunda 8 orchestrator for coordinating microservices through BPMN workflows and event streams"
spec:
  workload:
    definition:
      apiVersion: serving.knative.dev/v1
      kind: Service
    type: services.serving.knative.dev
  schematic:
    cue:
      template: |
        // Primary Output: Camunda Orchestrator Knative Service
        output: {
          apiVersion: "serving.knative.dev/v1"
          kind: "Service"
          metadata: {
            name: context.name
            namespace: context.namespace
            labels: {
              "app.kubernetes.io/name": context.name
              "app.kubernetes.io/component": "camunda-orchestrator"
              "app.kubernetes.io/managed-by": "kubevela"
              "app.kubernetes.io/part-of": "orchestration-platform"
              "orchestration.platform/type": "camunda"
            }
            annotations: {
              // Multi-cluster deployment support
              if parameter.targetEnvironment != _|_ {
                "app.oam.dev/cluster": parameter.targetEnvironment
              }
              "orchestrator.oam.dev/realtime-platform": parameter.realtimePlatform
              "orchestrator.oam.dev/workflow-patterns": "saga,choreography,orchestration"
              if parameter.repository != _|_ {
                "orchestrator.oam.dev/repository": parameter.repository
                "orchestrator.oam.dev/trigger-repo-creation": "true"
              }
            }
          }
          spec: {
            template: {
              metadata: {
                annotations: {
                  "autoscaling.knative.dev/minScale": "\(parameter.minScale)"
                  "autoscaling.knative.dev/maxScale": "\(parameter.maxScale)"
                  if parameter.targetConcurrency != _|_ {
                    "autoscaling.knative.dev/target": "\(parameter.targetConcurrency)"
                  }
                }
                labels: {
                  "app.kubernetes.io/name": context.name
                  "app.kubernetes.io/version": parameter.version
                  "orchestration.platform/type": "camunda"
                }
              }
              spec: {
                serviceAccountName: "camunda-orchestrator-sa"
                volumes: [
                  {
                    name: "workflow-config"
                    configMap: {
                      name: (*parameter.configMapName | context.name + "-config")
                    }
                  },
                  {
                    name: "bpmn-models"
                    configMap: {
                      name: (*parameter.bpmnConfigMapName | context.name + "-bpmn")
                    }
                  }
                ]
                containers: [{
                  // Generate image from service name
                  image: "docker.io/socrates12345/" + context.name + ":latest"
                  ports: [{
                    containerPort: 8080
                    name: "http1"
                  }]
                  resources: {
                    limits: {
                      cpu: parameter.resources.cpu
                      memory: parameter.resources.memory
                    }
                    requests: {
                      cpu: "200m"
                      memory: "256Mi"
                    }
                  }
                  volumeMounts: [
                    {
                      name: "workflow-config"
                      mountPath: "/app/config"
                    },
                    {
                      name: "bpmn-models"
                      mountPath: "/app/bpmn"
                    }
                  ]
                  env: [
                    {
                      name: "ORCHESTRATOR_NAME"
                      value: context.name
                    },
                    {
                      name: "NAMESPACE"
                      value: context.namespace
                    },
                    {
                      name: "REALTIME_PLATFORM_SERVICE"
                      value: parameter.realtimePlatform + "." + context.namespace + ".svc.cluster.local"
                    },
                    {
                      name: "CAMUNDA_MODE"
                      value: parameter.camundaMode
                    },
                    {
                      name: "WORKFLOW_ENGINE"
                      value: "camunda-8"
                    },
                    {
                      name: "EVENT_STREAMING_ENABLED"
                      value: "\(parameter.enableEventStreaming)"
                    },
                    {
                      name: "MICROSERVICE_DISCOVERY_SELECTOR"
                      value: "orchestration.platform/managed=true"
                    },
                    {
                      name: "KAFKA_TOPICS_PREFIX"
                      value: parameter.topicsPrefix
                    },
                    {
                      name: "ORCHESTRATION_PORT"
                      value: "8080"
                    },
                    {
                      name: "HOST"
                      value: "0.0.0.0"
                    },
                  ] + [
                    for k, v in parameter.environment {
                      name: k
                      value: v
                    },
                  ]
                  if parameter.envFrom != _|_ {
                    envFrom: parameter.envFrom
                  }
                  // Health checks for orchestrator stability
                  livenessProbe: {
                    httpGet: {
                      path: "/actuator/health"
                      port: 8080
                    }
                    initialDelaySeconds: 45
                    periodSeconds: 30
                  }
                  readinessProbe: {
                    httpGet: {
                      path: "/actuator/ready"
                      port: 8080
                    }
                    initialDelaySeconds: 15
                    periodSeconds: 10
                  }
                }]
              }
            }
          }
        }
        
        // Secondary Output: Orchestration Infrastructure (Redis, Kafka integration)
        outputs: {
          "orchestration-infrastructure": {
            apiVersion: "platform.example.org/v1alpha1"
            kind: "OrchestrationPlatformClaim"
            metadata: {
              name: context.name + "-infrastructure"
              namespace: context.namespace
              labels: {
                "app.kubernetes.io/name": context.name
                "app.kubernetes.io/component": "orchestration-infrastructure"
                "app.kubernetes.io/part-of": "orchestration-platform"
              }
            }
            spec: {
              orchestratorName: context.name
              realtimePlatformService: parameter.realtimePlatform
              camundaMode: parameter.camundaMode
              enableEventStreaming: parameter.enableEventStreaming
              sagaPatterns: parameter.sagaPatterns
              resources: {
                cpu: parameter.resources.cpu
                memory: parameter.resources.memory
              }
              if parameter.targetEnvironment != _|_ {
                targetEnvironment: parameter.targetEnvironment
              }
            }
          }
        }
        
        // Optional output: Istio Gateway for external access
        if parameter.enableIstioGateway != _|_ && parameter.enableIstioGateway == true {
          outputs: {
            // Include base infrastructure
            "orchestration-infrastructure": outputs["orchestration-infrastructure"]
            
            "istio-gateway": {
            apiVersion: "networking.istio.io/v1beta1"
            kind:       "Gateway"
            metadata: {
              name:      context.name + "-gateway"
              namespace: context.namespace
              annotations: {
                if parameter.targetEnvironment != _|_ {
                  "app.oam.dev/cluster": parameter.targetEnvironment
                }
                "orchestrator.oam.dev/component": context.name
              }
              labels: {
                "app.kubernetes.io/name": context.name
                "app.kubernetes.io/component": "istio-gateway"
                "app.kubernetes.io/part-of": "orchestration-platform"
              }
            }
            spec: {
              selector: {
                istio: "ingressgateway"
              }
              servers: [{
                port: {
                  number:   80
                  name:     "http"
                  protocol: "HTTP"
                }
                hosts: [(*parameter.gatewayHost | context.name + ".orchestration.local")]
                if parameter.enableTLS == true {
                  tls: {
                    httpsRedirect: true
                  }
                }
              }] + if parameter.enableTLS == true {
                [{
                  port: {
                    number:   443
                    name:     "https"
                    protocol: "HTTPS"
                  }
                  hosts: [(*parameter.gatewayHost | context.name + ".orchestration.local")]
                  tls: {
                    mode: "SIMPLE"
                    credentialName: context.name + "-tls-secret"
                  }
                }]
              } | *[]
            }
          }

            "istio-virtualservice": {
            apiVersion: "networking.istio.io/v1beta1"
            kind:       "VirtualService"
            metadata: {
              name:      context.name + "-vs"
              namespace: context.namespace
              annotations: {
                if parameter.targetEnvironment != _|_ {
                  "app.oam.dev/cluster": parameter.targetEnvironment
                }
                "orchestrator.oam.dev/component": context.name
              }
              labels: {
                "app.kubernetes.io/name": context.name
                "app.kubernetes.io/component": "istio-virtualservice"
                "app.kubernetes.io/part-of": "orchestration-platform"
              }
            }
            spec: {
              hosts: [(*parameter.gatewayHost | context.name + ".orchestration.local")]
              gateways: [context.name + "-gateway"]
              http: [{
                match: [{
                  uri: {
                    prefix: "/"
                  }
                }]
                route: [{
                  destination: {
                    host: context.name + "." + context.namespace + ".svc.cluster.local"
                    port: {
                      number: 80
                    }
                  }
                }]
              }]
            }
          }
          }
        }
        
        // Optional: Repository Creation Workflow (when language specified)
        if parameter.language != _|_ {
          outputs: {
            // Always include infrastructure
            "orchestration-infrastructure": outputs["orchestration-infrastructure"]
            
            // Add workflow trigger when language specified
            "workflow-trigger": {
              apiVersion: "batch/v1"
              kind: "Job"
              metadata: {
                name: context.name + "-workflow-trigger"
                namespace: context.namespace
                labels: {
                  "app.kubernetes.io/name": context.name
                  "app.kubernetes.io/component": "workflow-trigger"
                  "app.kubernetes.io/managed-by": "kubevela"
                  "app.kubernetes.io/part-of": "orchestration-platform"
                }
                annotations: {
                  "orchestrator.oam.dev/trigger-type": "argo-workflow"
                  "orchestrator.oam.dev/workflow-template": "microservice-standard-contract"
                  "orchestrator.oam.dev/source": "oam-driven"
                  "orchestrator.oam.dev/platform-type": "camunda-orchestrator"
                }
              }
              spec: {
                template: {
                  spec: {
                    serviceAccountName: "argo-workflows-client"
                    restartPolicy: "Never"
                    containers: [{
                      name: "workflow-trigger"
                      image: "curlimages/curl:7.85.0"
                      command: ["/bin/sh", "-c"]
                      args: [
                        """
                        echo "Triggering Argo Workflow for Camunda orchestrator repository creation..."
                        echo "Service: $(SERVICE_NAME)"
                        echo "Language: $(LANGUAGE)"
                        echo "Framework: $(FRAMEWORK)"
                        echo "Repository: $(REPOSITORY)"
                        
                        # Create workflow JSON for Argo submission
                        cat > /tmp/workflow.json << 'WORKFLOW_EOF'
                        {
                          "namespace": "argo",
                          "serverDryRun": false,
                          "workflow": {
                            "metadata": {
                              "generateName": "camunda-orchestrator-creation-",
                              "namespace": "argo",
                              "labels": {
                                "created-by": "oam-componentdefinition",
                                "service-name": "$(SERVICE_NAME)",
                                "source": "oam-driven",
                                "platform-type": "camunda-orchestrator"
                              }
                            },
                            "spec": {
                              "workflowTemplateRef": {
                                "name": "microservice-standard-contract"
                              },
                              "arguments": {
                                "parameters": [
                                  {"name": "resource-name", "value": "$(SERVICE_NAME)"},
                                  {"name": "resource-type", "value": "microservice"},
                                  {"name": "namespace", "value": "$(NAMESPACE)"},
                                  {"name": "user", "value": "oam-system"},
                                  {"name": "description", "value": "OAM-driven Camunda orchestrator via ComponentDefinition"},
                                  {"name": "github-org", "value": "shlapolosa"},
                                  {"name": "docker-registry", "value": "docker.io/socrates12345"},
                                  {"name": "slack-channel", "value": "#oam-notifications"},
                                  {"name": "slack-user-id", "value": "OAM"},
                                  {"name": "security-enabled", "value": "true"},
                                  {"name": "observability-enabled", "value": "true"},
                                  {"name": "backup-enabled", "value": "false"},
                                  {"name": "environment-tier", "value": "development"},
                                  {"name": "auto-create-dependencies", "value": "true"},
                                  {"name": "resource-size", "value": "large"},
                                  {"name": "microservice-language", "value": "$(LANGUAGE)"},
                                  {"name": "microservice-framework", "value": "$(FRAMEWORK)"},
                                  {"name": "microservice-database", "value": "postgres"},
                                  {"name": "microservice-cache", "value": "redis"},
                                  {"name": "microservice-expose-api", "value": "true"},
                                  {"name": "target-vcluster", "value": ""},
                                  {"name": "parent-appcontainer", "value": "$(REPOSITORY)"},
                                  {"name": "repository-name", "value": "$(REPOSITORY)"}
                                ]
                              }
                            }
                          }
                        }
                        WORKFLOW_EOF
                        
                        echo "ðŸ“‹ Workflow JSON created, submitting to Argo..."
                        
                        # Submit to Argo Workflows
                        RESPONSE=$(curl -s -w 'HTTPSTATUS:%{http_code}' -X POST -H "Content-Type: application/json" -H "Accept: application/json" -d @/tmp/workflow.json http://argo-server.argo.svc.cluster.local:2746/api/v1/workflows/argo)
                        HTTP_STATUS=$(echo $RESPONSE | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
                        BODY=$(echo $RESPONSE | sed -e 's/HTTPSTATUS:.*//g')
                        echo "ðŸ“Š HTTP Status:" $HTTP_STATUS
                        echo "ðŸ“„ Response:" $BODY
                        if [ "$HTTP_STATUS" -eq 200 ] || [ "$HTTP_STATUS" -eq 201 ]; then
                          echo "âœ… Workflow submission successful!"
                          echo "$BODY" | grep -o '"name":"[^"]*"' | head -1
                        else
                          echo "âŒ Workflow submission failed with status:" $HTTP_STATUS
                          echo "Response:" $BODY
                          exit 1
                        fi
                        
                        echo "Camunda orchestrator workflow trigger completed"
                        """
                      ]
                      env: [
                        {
                          name: "SERVICE_NAME"
                          value: context.name
                        },
                        {
                          name: "LANGUAGE"
                          value: parameter.language
                        },
                        {
                          name: "FRAMEWORK"
                          value: parameter.framework
                        },
                        {
                          name: "REPOSITORY"
                          value: (*parameter.repository | context.name)
                        },
                        {
                          name: "NAMESPACE"
                          value: context.namespace
                        }
                      ]
                    }]
                  }
                }
              }
            }
          }
        }
        
        parameter: {
          // Camunda Configuration
          camundaMode: *"embedded" | "remote" // embedded: Camunda 8 Self-Managed, remote: Camunda SaaS
          
          // Realtime Platform Integration (required)
          realtimePlatform: string  // Name of realtime-platform service for event streaming
          
          // Event-Driven Architecture
          enableEventStreaming: *true | bool
          topicsPrefix: *"orchestration" | string
          
          // Orchestration Patterns
          sagaPatterns: *["compensation", "timeout", "retry"] | [...string]
          
          // Service Discovery
          microserviceSelector: *{
            "orchestration.platform/managed": "true"
          } | {[string]: string}
          
          // Scaling Configuration
          minScale: *1 | int
          maxScale: *10 | int
          targetConcurrency?: int
          
          // Resource Management
          resources: *{
            cpu: "1000m"
            memory: "1Gi"
          } | {
            cpu?: string
            memory?: string
          }
          
          // Service Configuration
          version: *"latest" | string
          
          // Environment Variables
          environment: *{} | {[string]: string}
          
          // Environment Variables from Secrets
          envFrom?: [...{
            secretRef: {
              name: string
            }
          }]
          
          // Optional Infrastructure Bootstrap (for repository creation)
          language?: string     // Triggers bootstrap: nodejs, java, python
          framework?: string    // camunda-orchestrator
          repository?: string   // Git repository template name (defaults to name)
          
          // Multi-cluster support
          targetEnvironment?: string  // vCluster deployment target
          
          // External access (optional)
          enableIstioGateway?: bool
          gatewayHost?: string
          enableTLS?: bool
          
          // Configuration
          configMapName?: string     // ConfigMap name for orchestrator configuration
          bpmnConfigMapName?: string // ConfigMap name for BPMN workflow models
        }
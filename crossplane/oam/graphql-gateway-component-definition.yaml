---
# GraphQL Gateway ComponentDefinition
# Architecturally follows the same pattern as realtime-platform: OAM Component â†’ Knative Service + Infrastructure Claims
apiVersion: core.oam.dev/v1beta1
kind: ComponentDefinition
metadata:
  name: graphql-gateway
  annotations:
    definition.oam.dev/description: "Auto-generating GraphQL API gateway that discovers and federates Knative services"
spec:
  workload:
    definition:
      apiVersion: serving.knative.dev/v1
      kind: Service
    type: services.serving.knative.dev
  schematic:
    cue:
      template: |
        // Primary Output: GraphQL Gateway Knative Service (OAM-compliant workload)
        output: {
          apiVersion: "serving.knative.dev/v1"
          kind: "Service"
          metadata: {
            name: context.name
            namespace: context.namespace
            labels: {
              "app.kubernetes.io/name": context.name
              "app.kubernetes.io/component": "graphql-gateway"
              "app.kubernetes.io/managed-by": "kubevela"
              "app.kubernetes.io/part-of": "graphql-platform"
              "app": context.name
            }
            annotations: {
              // Multi-cluster deployment support
              if parameter.targetEnvironment != _|_ {
                "app.oam.dev/cluster": parameter.targetEnvironment
              }
              "graphql-gateway.oam.dev/bootstrap": "true"
              "graphql-gateway.oam.dev/auto-schema": "\(parameter.autoSchema)"
              if parameter.repository != _|_ {
                "graphql-gateway.oam.dev/repository": parameter.repository
                "graphql-gateway.oam.dev/trigger-repo-creation": "true"
              }
            }
          }
          spec: {
            template: {
              metadata: {
                annotations: {
                  "autoscaling.knative.dev/minScale": "1"
                  "autoscaling.knative.dev/maxScale": "10"
                  "run.googleapis.com/execution-environment": "gen2"
                }
                labels: {
                  "app.kubernetes.io/name": context.name
                  "app.kubernetes.io/version": parameter.version
                  "app.kubernetes.io/part-of": "graphql-platform"
                  "app": context.name
                }
              }
              spec: {
                serviceAccountName: "graphql-gateway-sa"
                volumes: [
                  {
                    name: "gateway-config"
                    configMap: {
                      name: (*parameter.configMapName | context.name + "-config")
                    }
                  }
                ]
                containers: [{
                  // Generate image from service name, require repository for deployment
                  image: "docker.io/socrates12345/" + context.name + ":latest"
                  ports: [{
                    containerPort: 8080
                    name: "http1"
                  }]
                  resources: {
                    limits: {
                      cpu: parameter.resources.cpu
                      memory: parameter.resources.memory
                    }
                    requests: {
                      cpu: "100m"
                      memory: "128Mi"
                    }
                  }
                  volumeMounts: [
                    {
                      name: "gateway-config"
                      mountPath: "/app/config"
                    }
                  ]
                  env: [
                    {
                      name: "GATEWAY_NAME"
                      value: context.name
                    },
                    {
                      name: "NAMESPACE"
                      value: context.namespace
                    },
                    {
                      name: "SERVICE_SELECTOR_LABELS"
                      value: "graphql.federation/enabled=true"
                    },
                    {
                      name: "AUTO_DISCOVERY"
                      value: "\(parameter.autoSchema)"
                    },
                    {
                      name: "DISCOVERY_INTERVAL"
                      value: parameter.schemaRefreshInterval
                    },
                    {
                      name: "GATEWAY_PORT"
                      value: "8080"
                    },
                    {
                      name: "HOST"
                      value: "0.0.0.0"
                    },
                    {
                      name: "FEDERATION_ANNOTATION"
                      value: "graphql.federation/enabled"
                    },
                  ] + [
                    for k, v in parameter.environment {
                      name: k
                      value: v
                    }
                  ]
                  if parameter.envFrom != _|_ {
                    envFrom: parameter.envFrom
                  }
                  // Health checks for robust deployment
                  livenessProbe: {
                    httpGet: {
                      path: "/healthz"
                      port: 8080
                    }
                    initialDelaySeconds: 30
                    periodSeconds: 10
                  }
                  readinessProbe: {
                    httpGet: {
                      path: "/healthz"
                      port: 8080
                    }
                    initialDelaySeconds: 5
                    periodSeconds: 5
                  }
                }]
              }
            }
          }
        }
        
        // Secondary Output: GraphQL Platform Infrastructure (always created)
        outputs: {
          "graphql-infrastructure": {
            apiVersion: "platform.example.org/v1alpha1"
            kind: "GraphQLPlatformClaim"
            metadata: {
              name: context.name + "-infrastructure"
              namespace: context.namespace
              labels: {
                "app.kubernetes.io/name": context.name
                "app.kubernetes.io/component": "graphql-infrastructure"
                "app.kubernetes.io/part-of": "graphql-platform"
              }
            }
            spec: {
              name: context.name
              serviceSelector: parameter.serviceSelector
              autoSchema: parameter.autoSchema
              schemaRefreshInterval: parameter.schemaRefreshInterval
              exposeIntrospection: parameter.exposeIntrospection
              exposePlayground: parameter.exposePlayground
              enableCors: parameter.enableCors
              if parameter.customResolvers != _|_ {
                customResolvers: parameter.customResolvers
              }
              resources: {
                cpu: parameter.resources.cpu
                memory: parameter.resources.memory
              }
              if parameter.targetEnvironment != _|_ {
                targetEnvironment: parameter.targetEnvironment
              }
            }
          }
        }
        
        // Optional output: Istio Gateway for external access
        if parameter.enableIstioGateway != _|_ && parameter.enableIstioGateway == true {
          outputs: "istio-gateway": {
            apiVersion: "networking.istio.io/v1beta1"
            kind:       "Gateway"
            metadata: {
              name:      context.name + "-gateway"
              namespace: context.namespace
              annotations: {
                // Multi-cluster deployment support
                if parameter.targetEnvironment != _|_ {
                  "app.oam.dev/cluster": parameter.targetEnvironment
                }
                "graphql-gateway.oam.dev/component": context.name
              }
              labels: {
                "app.kubernetes.io/name": context.name
                "app.kubernetes.io/component": "istio-gateway"
                "app.kubernetes.io/part-of": "graphql-platform"
              }
            }
            spec: {
              selector: {
                istio: "ingressgateway"
              }
              servers: [{
                port: {
                  number:   80
                  name:     "http"
                  protocol: "HTTP"
                }
                hosts: [(*parameter.gatewayHost | context.name + ".local")]
                if parameter.enableTLS == true {
                  tls: {
                    httpsRedirect: true
                  }
                }
              }]
              if parameter.enableTLS == true {
                servers: [{
                  port: {
                    number:   80
                    name:     "http"
                    protocol: "HTTP"
                  }
                  hosts: [(*parameter.gatewayHost | context.name + ".local")]
                  tls: {
                    httpsRedirect: true
                  }
                }, {
                  port: {
                    number:   443
                    name:     "https"
                    protocol: "HTTPS"
                  }
                  hosts: [(*parameter.gatewayHost | context.name + ".local")]
                  tls: {
                    mode: "SIMPLE"
                    credentialName: context.name + "-tls-secret"
                  }
                }]
              }
            }
          }

          outputs: "istio-virtualservice": {
            apiVersion: "networking.istio.io/v1beta1"
            kind:       "VirtualService"
            metadata: {
              name:      context.name + "-vs"
              namespace: context.namespace
              annotations: {
                // Multi-cluster deployment support
                if parameter.targetEnvironment != _|_ {
                  "app.oam.dev/cluster": parameter.targetEnvironment
                }
                "graphql-gateway.oam.dev/component": context.name
              }
              labels: {
                "app.kubernetes.io/name": context.name
                "app.kubernetes.io/component": "istio-virtualservice"
                "app.kubernetes.io/part-of": "graphql-platform"
              }
            }
            spec: {
              hosts: [(*parameter.gatewayHost | context.name + ".local")]
              gateways: [context.name + "-gateway"]
              http: [{
                match: [{
                  uri: {
                    prefix: "/"
                  }
                }]
                rewrite: {
                  uri: "/"
                }
                route: [{
                  destination: {
                    host: context.name + "." + context.namespace + ".svc.cluster.local"
                    port: {
                      number: 80
                    }
                  }
                }]
              }]
            }
          }
        }
        
        // Optional: Repository Creation Workflow (when language specified - follows webservice pattern)
        if parameter.language != _|_ {
          outputs: {
            // Always include infrastructure
            "graphql-infrastructure": outputs["graphql-infrastructure"]
            
            // Add workflow trigger when language specified
            "workflow-trigger": {
              apiVersion: "batch/v1"
              kind: "Job"
              metadata: {
                name: context.name + "-workflow-trigger"
                namespace: context.namespace
                labels: {
                  "app.kubernetes.io/name": context.name
                  "app.kubernetes.io/component": "workflow-trigger"
                  "app.kubernetes.io/managed-by": "kubevela"
                  "app.kubernetes.io/part-of": "graphql-platform"
                }
                annotations: {
                  "graphql-gateway.oam.dev/trigger-type": "argo-workflow"
                  "graphql-gateway.oam.dev/workflow-template": "microservice-standard-contract"
                  "graphql-gateway.oam.dev/source": "oam-driven"
                  "graphql-gateway.oam.dev/platform-type": "graphql"
                }
              }
              spec: {
                template: {
                  spec: {
                    serviceAccountName: "argo-workflows-client"
                    restartPolicy: "Never"
                    volumes: []
                    containers: [{
                      name: "workflow-trigger"
                      image: "curlimages/curl:7.85.0"
                      command: ["/bin/sh", "-c"]
                      args: [
                        """
                        echo "Triggering Argo Workflow for GraphQL gateway repository creation..."
                        echo "Service: $(SERVICE_NAME)"
                        echo "Language: $(LANGUAGE)"
                        echo "Framework: $(FRAMEWORK)"
                        echo "Repository: $(REPOSITORY)"
                        
                        # Create workflow JSON for Argo submission
                        cat > /tmp/workflow.json << 'WORKFLOW_EOF'
                        {
                          "namespace": "argo",
                          "serverDryRun": false,
                          "workflow": {
                            "metadata": {
                              "generateName": "graphql-gateway-creation-",
                              "namespace": "argo",
                              "labels": {
                                "created-by": "oam-componentdefinition",
                                "service-name": "$(SERVICE_NAME)",
                                "source": "oam-driven",
                                "platform-type": "graphql"
                              }
                            },
                            "spec": {
                              "workflowTemplateRef": {
                                "name": "microservice-standard-contract"
                              },
                              "arguments": {
                                "parameters": [
                                  {"name": "resource-name", "value": "$(SERVICE_NAME)"},
                                  {"name": "resource-type", "value": "microservice"},
                                  {"name": "namespace", "value": "$(NAMESPACE)"},
                                  {"name": "user", "value": "oam-system"},
                                  {"name": "description", "value": "OAM-driven GraphQL gateway via ComponentDefinition"},
                                  {"name": "github-org", "value": "shlapolosa"},
                                  {"name": "docker-registry", "value": "docker.io/socrates12345"},
                                  {"name": "slack-channel", "value": "#oam-notifications"},
                                  {"name": "slack-user-id", "value": "OAM"},
                                  {"name": "security-enabled", "value": "true"},
                                  {"name": "observability-enabled", "value": "true"},
                                  {"name": "backup-enabled", "value": "false"},
                                  {"name": "environment-tier", "value": "development"},
                                  {"name": "auto-create-dependencies", "value": "true"},
                                  {"name": "resource-size", "value": "medium"},
                                  {"name": "microservice-language", "value": "$(LANGUAGE)"},
                                  {"name": "microservice-framework", "value": "$(FRAMEWORK)"},
                                  {"name": "microservice-database", "value": "none"},
                                  {"name": "microservice-cache", "value": "redis"},
                                  {"name": "microservice-expose-api", "value": "true"},
                                  {"name": "target-vcluster", "value": ""},
                                  {"name": "parent-appcontainer", "value": "$(REPOSITORY)"},
                                  {"name": "repository-name", "value": "$(REPOSITORY)"}
                                ]
                              }
                            }
                          }
                        }
                        WORKFLOW_EOF
                        
                        echo "ðŸ“‹ Workflow JSON created, submitting to Argo..."
                        cat /tmp/workflow.json
                        
                        # Submit to Argo Workflows
                        RESPONSE=$(curl -s -w 'HTTPSTATUS:%{http_code}' -X POST -H "Content-Type: application/json" -H "Accept: application/json" -d @/tmp/workflow.json http://argo-server.argo.svc.cluster.local:2746/api/v1/workflows/argo)
                        HTTP_STATUS=$(echo $RESPONSE | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
                        BODY=$(echo $RESPONSE | sed -e 's/HTTPSTATUS:.*//g')
                        echo "ðŸ“Š HTTP Status:" $HTTP_STATUS
                        echo "ðŸ“„ Response:" $BODY
                        if [ "$HTTP_STATUS" -eq 200 ] || [ "$HTTP_STATUS" -eq 201 ]; then
                          echo "âœ… Workflow submission successful!"
                          echo "$BODY" | grep -o '"name":"[^"]*"' | head -1
                        else
                          echo "âŒ Workflow submission failed with status:" $HTTP_STATUS
                          echo "Response:" $BODY
                          exit 1
                        fi
                        
                        echo "GraphQL gateway workflow trigger completed"
                        """
                      ]
                      env: [
                        {
                          name: "SERVICE_NAME"
                          value: context.name
                        },
                        {
                          name: "LANGUAGE"
                          value: parameter.language
                        },
                        {
                          name: "FRAMEWORK"
                          value: parameter.framework
                        },
                        {
                          name: "REPOSITORY"
                          value: (*parameter.repository | context.name)
                        },
                        {
                          name: "NAMESPACE"
                          value: context.namespace
                        }
                      ]
                      volumeMounts: []
                    }]
                  }
                }
              }
            }
          }
        }
        
        parameter: {
          // Repository-based image generation (required when repository specified)
          gatewayImage: *"" | string
          
          // Service Discovery
          serviceSelector: *{
            "graphql.federation/enabled": "true"
          } | {[string]: string}
          
          // Schema Management
          autoSchema: *true | bool
          schemaRefreshInterval: *"5m" | string
          exposeIntrospection: *false | bool
          
          // GraphQL Gateway Configuration
          exposePlayground: *true | bool
          enableCors: *true | bool
          
          // Resource Management
          resources: *{
            cpu: "500m"
            memory: "512Mi"
          } | {
            cpu?: string
            memory?: string
          }
          
          // Service Configuration
          version: *"latest" | string
          
          // Environment Variables
          environment: *{} | {[string]: string}
          
          // Environment Variables from Secrets
          envFrom?: [...{
            secretRef: {
              name: string
            }
          }]
          
          // Optional Infrastructure Bootstrap (for repository creation)
          language?: string     // Triggers bootstrap: nodejs, typescript
          framework?: string    // graphql-gateway
          repository?: string   // Git repository template name (defaults to name)
          
          // Advanced Options
          customResolvers?: [...{
            name: string
            endpoint: string
            headers?: {[string]: string}
          }]
          
          // Multi-cluster support
          targetEnvironment?: string  // vCluster deployment target
          
          // External access (optional)
          enableIstioGateway?: bool
          gatewayHost?: string
          enableTLS?: bool
          
          // Configuration
          configMapName?: string  // ConfigMap name for gateway configuration
        }
# Consolidated OAM ComponentDefinitions
# Following Architecture Principles:
# 1. Single component declaration creates everything needed
# 2. ComponentDefinition-only (no Claims for basic components)
# 3. Embedded workflows for complex orchestration
# 4. KubeVela orchestrates, Crossplane executes

---
# Enhanced WebService ComponentDefinition with Parameter Transformation
# Works with webservice WorkloadDefinition for Knative Service rendering
apiVersion: core.oam.dev/v1beta1
kind: ComponentDefinition
metadata:
  name: webservice
  annotations:
    definition.oam.dev/description: "Enhanced webservice with automatic infrastructure bootstrap via embedded workflows"
spec:
  workload:
    definition:
      apiVersion: serving.knative.dev/v1
      kind: Service
    type: services.serving.knative.dev
  schematic:
    cue:
      template: |
        output: {
          apiVersion: "serving.knative.dev/v1"
          kind: "Service"
          metadata: {
            name: context.name
            namespace: context.namespace
            labels: {
              "app.kubernetes.io/name": context.name
              "app.kubernetes.io/component": "web-service"
              "app.kubernetes.io/managed-by": "kubevela"
            }
            annotations: {
              // Multi-cluster deployment support
              if parameter.targetEnvironment != _|_ {
                "app.oam.dev/cluster": parameter.targetEnvironment
              }
              if parameter.language != _|_ {
                "webservice.oam.dev/bootstrap": "true"
                "webservice.oam.dev/language": parameter.language
                "webservice.oam.dev/framework": parameter.framework
                if parameter.source != _|_ {
                  "webservice.oam.dev/source": parameter.source
                }
                if parameter.source == _|_ {
                  "webservice.oam.dev/source": "api-driven"
                }
              }
              if parameter.realtime != _|_ {
                "realtime.platform.example.org/integration": parameter.realtime
                "webservice.oam.dev/secret-discovery": "enabled"
                "webservice.oam.dev/secret-pattern": parameter.realtime + "-*-secret"
              }
            }
          }
          spec: {
            template: {
              metadata: {
                annotations: {
                  "autoscaling.knative.dev/minScale": "0"
                  "autoscaling.knative.dev/maxScale": "10"
                  "run.googleapis.com/execution-environment": "gen2"
                }
                labels: {
                  "app.kubernetes.io/name": context.name
                  "app.kubernetes.io/version": parameter.version
                }
              }
              spec: {
                serviceAccountName: "knative-docker-sa"
                containers: [{
                  image: parameter.image
                  ports: [{
                    containerPort: parameter.port
                    name: "http1"
                  }]
                  resources: {
                    limits: {
                      cpu: parameter.resources.cpu
                      memory: parameter.resources.memory
                    }
                    requests: {
                      cpu: "100m"
                      memory: "128Mi"
                    }
                  }
                  env: [
                    for k, v in parameter.environment {
                      name: k
                      value: v
                    }
                  ] + [
                    if parameter.realtime != _|_ {
                      {
                        name: "REALTIME_PLATFORM_NAME"
                        value: parameter.realtime
                      }
                    },
                    if parameter.realtime != _|_ {
                      {
                        name: "REALTIME_INTEGRATION_ENABLED"
                        value: "true"
                      }
                    },
                    if parameter.realtime != _|_ {
                      {
                        name: "WEBSERVICE_NAME"
                        value: context.name
                      }
                    }
                  ]
                  if parameter.envFrom != _|_ || parameter.realtime != _|_ {
                    envFrom: [
                      if parameter.envFrom != _|_ {
                        for envRef in parameter.envFrom {
                          envRef
                        }
                      }
                    ] + [
                      if parameter.realtime != _|_ {
                        {
                          secretRef: {
                            name: parameter.realtime + "-kafka-secret"
                            optional: true
                          }
                        }
                      },
                      if parameter.realtime != _|_ {
                        {
                          secretRef: {
                            name: parameter.realtime + "-mqtt-secret" 
                            optional: true
                          }
                        }
                      },
                      if parameter.realtime != _|_ {
                        {
                          secretRef: {
                            name: parameter.realtime + "-db-secret"
                            optional: true
                          }
                        }
                      },
                      if parameter.realtime != _|_ {
                        {
                          secretRef: {
                            name: parameter.realtime + "-metabase-secret"
                            optional: true
                          }
                        }
                      },
                      if parameter.realtime != _|_ {
                        {
                          secretRef: {
                            name: parameter.realtime + "-lenses-secret"
                            optional: true
                          }
                        }
                      }
                    ]
                  }
                  // Health checks for robust deployment
                  livenessProbe: {
                    httpGet: {
                      path: parameter.healthPath
                      port: parameter.port
                    }
                    initialDelaySeconds: 30
                    periodSeconds: 10
                  }
                  readinessProbe: {
                    httpGet: {
                      path: parameter.healthPath
                      port: parameter.port
                    }
                    initialDelaySeconds: 5
                    periodSeconds: 5
                  }
                }]
              }
            }
          }
        }
        
        // Secondary Outputs: Infrastructure Bootstrap via Argo Workflow (when language specified)
        if parameter.language != _|_ {
          outputs: {
            // Create Job to trigger Argo Workflow for microservice creation
            "workflow-trigger": {
              apiVersion: "batch/v1"
              kind: "Job"
              metadata: {
                name: context.name + "-workflow-trigger"
                namespace: context.namespace
                labels: {
                  "app.kubernetes.io/name": context.name
                  "app.kubernetes.io/component": "workflow-trigger"
                  "app.kubernetes.io/managed-by": "kubevela"
                }
                annotations: {
                  "webservice.oam.dev/trigger-type": "argo-workflow"
                  "webservice.oam.dev/workflow-template": "microservice-standard-contract"
                  if parameter.source != _|_ {
                    "webservice.oam.dev/source": parameter.source
                  }
                  if parameter.source == _|_ {
                    "webservice.oam.dev/source": "oam-driven"
                  }
                }
              }
              spec: {
                template: {
                  spec: {
                    serviceAccountName: "argo-workflows-client"
                    restartPolicy: "Never"
                    volumes: [
                      {
                        name: "argo-token"
                        secret: {
                          secretName: "slack-api-argo-token-copy"
                        }
                      }
                    ]
                    containers: [{
                      name: "workflow-trigger"
                      image: "curlimages/curl:latest"
                      command: ["/bin/sh", "-c"]
                      volumeMounts: [
                        {
                          name: "argo-token"
                          mountPath: "/var/run/secrets/argo"
                          readOnly: true
                        }
                      ]
                      args: [
                        "echo 'ðŸš€ Triggering Argo Workflow for microservice: " + context.name + "'\n" +
                        "cat > /tmp/workflow.json << 'WORKFLOW_EOF'\n" +
                        "{\n" +
                        "  \"namespace\": \"argo\",\n" +
                        "  \"serverDryRun\": false,\n" +
                        "  \"workflow\": {\n" +
                        "    \"metadata\": {\n" +
                        "      \"generateName\": \"microservice-creation-\",\n" +
                        "      \"namespace\": \"argo\",\n" +
                        "      \"labels\": {\n" +
                        "        \"created-by\": \"oam-componentdefinition\",\n" +
                        "        \"microservice-name\": \"" + context.name + "\",\n" +
                        "        \"source\": \"" + (*"oam-driven" | parameter.source) + "\"\n" +
                        "      }\n" +
                        "    },\n" +
                        "    \"spec\": {\n" +
                        "      \"workflowTemplateRef\": {\n" +
                        "        \"name\": \"microservice-standard-contract\"\n" +
                        "      },\n" +
                        "      \"arguments\": {\n" +
                        "        \"parameters\": [\n" +
                        "          {\"name\": \"resource-name\", \"value\": \"" + context.name + "\"},\n" +
                        "          {\"name\": \"resource-type\", \"value\": \"microservice\"},\n" +
                        "          {\"name\": \"namespace\", \"value\": \"" + context.namespace + "\"},\n" +
                        "          {\"name\": \"user\", \"value\": \"oam-system\"},\n" +
                        "          {\"name\": \"description\", \"value\": \"OAM-driven microservice via ComponentDefinition\"},\n" +
                        "          {\"name\": \"github-org\", \"value\": \"shlapolosa\"},\n" +
                        "          {\"name\": \"docker-registry\", \"value\": \"docker.io/socrates12345\"},\n" +
                        "          {\"name\": \"slack-channel\", \"value\": \"#oam-notifications\"},\n" +
                        "          {\"name\": \"slack-user-id\", \"value\": \"OAM\"},\n" +
                        "          {\"name\": \"security-enabled\", \"value\": \"true\"},\n" +
                        "          {\"name\": \"observability-enabled\", \"value\": \"true\"},\n" +
                        "          {\"name\": \"backup-enabled\", \"value\": \"false\"},\n" +
                        "          {\"name\": \"environment-tier\", \"value\": \"development\"},\n" +
                        "          {\"name\": \"auto-create-dependencies\", \"value\": \"true\"},\n" +
                        "          {\"name\": \"resource-size\", \"value\": \"medium\"},\n" +
                        "          {\"name\": \"microservice-language\", \"value\": \"" + parameter.language + "\"},\n" +
                        "          {\"name\": \"microservice-framework\", \"value\": \"" + parameter.framework + "\"},\n" +
                        "          {\"name\": \"microservice-database\", \"value\": \"none\"},\n" +
                        "          {\"name\": \"microservice-cache\", \"value\": \"none\"},\n" +
                        "          {\"name\": \"microservice-expose-api\", \"value\": \"false\"},\n" +
                        "          {\"name\": \"target-vcluster\", \"value\": \"\"},\n" +
                        "          {\"name\": \"parent-appcontainer\", \"value\": \"\"},\n" +
                        "          {\"name\": \"repository-name\", \"value\": \"" + (*context.name | parameter.repository) + "\"}\n" +
                        "        ]\n" +
                        "      }\n" +
                        "    }\n" +
                        "  }\n" +
                        "}\n" +
                        "WORKFLOW_EOF\n" +
                        "echo 'ðŸ“‹ Workflow JSON created, submitting to Argo...'\n" +
                        "cat /tmp/workflow.json\n" +
                        "RESPONSE=$(curl -s -k -w 'HTTPSTATUS:%{http_code}' -X POST -H \"Authorization: Bearer $(cat /var/run/secrets/argo/token)\" -H 'Content-Type: application/json' -H 'Accept: application/json' -d @/tmp/workflow.json https://argo-server.argo.svc.cluster.local:2746/api/v1/workflows/argo)\n" +
                        "HTTP_STATUS=$(echo $RESPONSE | tr -d '\\n' | sed -e 's/.*HTTPSTATUS://')\n" +
                        "BODY=$(echo $RESPONSE | sed -e 's/HTTPSTATUS:.*//g')\n" +
                        "echo 'ðŸ“Š HTTP Status:' $HTTP_STATUS\n" +
                        "echo 'ðŸ“„ Response:' $BODY\n" +
                        "if [ \"$HTTP_STATUS\" -eq 200 ] || [ \"$HTTP_STATUS\" -eq 201 ]; then\n" +
                        "  echo 'âœ… Workflow submission successful!'\n" +
                        "  echo \"$BODY\" | grep -o '\"name\":\"[^\"]*\"' | head -1\n" +
                        "else\n" +
                        "  echo 'âŒ Workflow submission failed with status:' $HTTP_STATUS\n" +
                        "  echo 'Response:' $BODY\n" +
                        "  exit 1\n" +
                        "fi"
                      ]
                    }]
                  }
                }
              }
            }
          }
        }
        
        parameter: {
          // Required Parameters
          image: string
          port: *8080 | int
          version: *"latest" | string
          healthPath: *"/health" | string
          resources: *{
            cpu: "500m"
            memory: "512Mi"
          } | {
            cpu?: string
            memory?: string
          }
          environment: *{} | {[string]: string}
          envFrom?: [...{
            secretRef: {
              name: string
            }
          }]
          language?: string
          framework?: string
          source?: string
          realtime?: string
          repository?: string
          targetEnvironment?: string  // vCluster deployment target
        }

---
# Native Kafka ComponentDefinition (Crossplane-managed via Helm)
apiVersion: core.oam.dev/v1beta1
kind: ComponentDefinition
metadata:
  name: kafka
  annotations:
    definition.oam.dev/description: "Apache Kafka event streaming platform via Crossplane Helm provider"
spec:
  workload:
    definition:
      apiVersion: helm.crossplane.io/v1beta1
      kind: Release
  schematic:
    cue:
      template: |
        output: {
          apiVersion: "helm.crossplane.io/v1beta1"
          kind: "Release"
          metadata: {
            name: parameter.name + "-kafka"
            namespace: context.namespace
            // Multi-cluster deployment support
            if parameter.targetEnvironment != _|_ {
              annotations: {
                "app.oam.dev/cluster": parameter.targetEnvironment
              }
            }
          }
          spec: {
            forProvider: {
              chart: {
                name: "kafka"
                repository: "https://charts.bitnami.com/bitnami"
                version: "26.8.5"
              }
              namespace: context.namespace
              skipCreateNamespace: false
              values: {
                replicaCount: parameter.replicas
                persistence: {
                  enabled: true
                  size: parameter.storage
                }
                service: {
                  type: "ClusterIP"
                }
                auth: {
                  clientProtocol: "plaintext"
                  interBrokerProtocol: "plaintext"
                }
                metrics: {
                  kafka: {
                    enabled: true
                  }
                  jmx: {
                    enabled: true
                  }
                }
                if parameter.zookeeper.enabled {
                  zookeeper: {
                    enabled: true
                    replicaCount: parameter.zookeeper.replicas
                    persistence: {
                      enabled: true
                      size: parameter.zookeeper.storage
                    }
                  }
                }
              }
            }
            providerConfigRef: {
              name: "default"
            }
          }
        }
        
        parameter: {
          // Required
          name: string
          
          // Optional
          replicas: *3 | int
          storage: *"10Gi" | string
          zookeeper: *{
            enabled: true
            replicas: 3
            storage: "8Gi"
          } | {
            enabled: bool
            replicas?: int
            storage?: string
          }
          targetEnvironment?: string  // vCluster deployment target
        }

---
# Native Redis ComponentDefinition (Crossplane-managed via Helm)
apiVersion: core.oam.dev/v1beta1
kind: ComponentDefinition
metadata:
  name: redis
  annotations:
    definition.oam.dev/description: "Redis in-memory data store via Crossplane Helm provider"
spec:
  workload:
    definition:
      apiVersion: helm.crossplane.io/v1beta1
      kind: Release
  schematic:
    cue:
      template: |
        output: {
          apiVersion: "helm.crossplane.io/v1beta1"
          kind: "Release"
          metadata: {
            name: parameter.name + "-redis"
            namespace: context.namespace
            // Multi-cluster deployment support
            if parameter.targetEnvironment != _|_ {
              annotations: {
                "app.oam.dev/cluster": parameter.targetEnvironment
              }
            }
          }
          spec: {
            forProvider: {
              chart: {
                name: "redis"
                repository: "https://charts.bitnami.com/bitnami"
                version: "18.19.4"
              }
              namespace: context.namespace
              skipCreateNamespace: false
              values: {
                architecture: parameter.architecture
                auth: {
                  enabled: parameter.auth.enabled
                  if parameter.auth.enabled {
                    password: parameter.auth.password
                  }
                }
                master: {
                  persistence: {
                    enabled: true
                    size: parameter.storage
                  }
                  resources: {
                    requests: {
                      cpu: parameter.resources.cpu
                      memory: parameter.resources.memory
                    }
                    limits: {
                      cpu: parameter.resources.cpu
                      memory: parameter.resources.memory
                    }
                  }
                }
                if parameter.architecture == "replication" {
                  replica: {
                    replicaCount: parameter.replicas
                    persistence: {
                      enabled: true
                      size: parameter.storage
                    }
                    resources: {
                      requests: {
                        cpu: parameter.resources.cpu
                        memory: parameter.resources.memory
                      }
                      limits: {
                        cpu: parameter.resources.cpu
                        memory: parameter.resources.memory
                      }
                    }
                  }
                }
                metrics: {
                  enabled: false
                }
              }
            }
            providerConfigRef: {
              name: "default"
            }
          }
        }
        
        parameter: {
          // Required
          name: string
          
          // Optional
          architecture: *"standalone" | "replication"
          replicas: *2 | int
          storage: *"8Gi" | string
          auth: *{
            enabled: false
          } | {
            enabled: bool
            password?: string
          }
          resources: *{
            cpu: "100m"
            memory: "128Mi"
          } | {
            cpu: string
            memory: string
          }
          targetEnvironment?: string  // vCluster deployment target
        }

---
# Native MongoDB ComponentDefinition (Crossplane-managed via Helm)
apiVersion: core.oam.dev/v1beta1
kind: ComponentDefinition
metadata:
  name: mongodb
  annotations:
    definition.oam.dev/description: "MongoDB document database via Crossplane Helm provider"
spec:
  workload:
    definition:
      apiVersion: helm.crossplane.io/v1beta1
      kind: Release
  schematic:
    cue:
      template: |
        output: {
          apiVersion: "helm.crossplane.io/v1beta1"
          kind: "Release"
          metadata: {
            name: parameter.name + "-mongodb"
            namespace: context.namespace
            // Multi-cluster deployment support
            if parameter.targetEnvironment != _|_ {
              annotations: {
                "app.oam.dev/cluster": parameter.targetEnvironment
              }
            }
          }
          spec: {
            forProvider: {
              chart: {
                name: "mongodb"
                repository: "https://charts.bitnami.com/bitnami"
                version: "15.6.13"
              }
              namespace: context.namespace
              skipCreateNamespace: false
              values: {
                architecture: parameter.architecture
                auth: {
                  enabled: parameter.auth.enabled
                  if parameter.auth.enabled {
                    rootPassword: parameter.auth.rootPassword
                    username: parameter.auth.username
                    password: parameter.auth.password
                    database: parameter.auth.database
                  }
                }
                persistence: {
                  enabled: true
                  size: parameter.storage
                }
                resources: {
                  requests: {
                    cpu: parameter.resources.cpu
                    memory: parameter.resources.memory
                  }
                  limits: {
                    cpu: parameter.resources.cpu
                    memory: parameter.resources.memory
                  }
                }
                if parameter.architecture == "replicaset" {
                  replicaCount: parameter.replicas
                  replicaSetName: parameter.name + "-rs"
                }
                metrics: {
                  enabled: false
                }
              }
            }
            providerConfigRef: {
              name: "default"
            }
          }
        }
        
        parameter: {
          // Required
          name: string
          
          // Optional
          architecture: *"standalone" | "replicaset"
          replicas: *3 | int
          storage: *"8Gi" | string
          auth: *{
            enabled: true
            rootPassword: "mongopass"
            username: "mongodb"
            password: "mongodb"
            database: "mydb"
          } | {
            enabled: bool
            rootPassword?: string
            username?: string
            password?: string
            database?: string
          }
          resources: *{
            cpu: "500m"
            memory: "512Mi"
          } | {
            cpu: string
            memory: string
          }
          targetEnvironment?: string  // vCluster deployment target
        }

---
# Infrastructure Components (Create Crossplane Claims for complex infrastructure)

# Application Infrastructure Component (for complex setups)
apiVersion: core.oam.dev/v1beta1
kind: ComponentDefinition
metadata:
  name: application-infrastructure
  annotations:
    definition.oam.dev/description: "Complete application infrastructure including repos, databases, caches, and secrets. Use when you need the full ApplicationClaim workflow."
spec:
  workload:
    definition:
      apiVersion: platform.example.org/v1alpha1
      kind: ApplicationClaim
  schematic:
    cue:
      template: |
        output: {
          apiVersion: "platform.example.org/v1alpha1"
          kind: "ApplicationClaim"
          metadata: {
            name: parameter.name + "-infra"
            namespace: context.namespace
          }
          spec: {
            name: parameter.name
            language: parameter.language
            framework: parameter.framework
            if parameter.database != _|_ {
              database: parameter.database
            }
            if parameter.cache != _|_ {
              cache: parameter.cache
            }
            if parameter.generateRepo != _|_ {
              generateRepo: parameter.generateRepo
            }
            resources: {
              cpu: parameter.resources.cpu
              memory: parameter.resources.memory
            }
            environment: parameter.environment
          }
        }
        
        parameter: {
          // Required
          name: string
          language: "python" | "java" | "javascript" | "go"
          framework: string
          
          // Optional
          database?: "postgres" | "mysql" | "mongodb"
          cache?: "redis" | "memcached"
          generateRepo: *false | bool
          environment: *{} | {...}
          resources: *{
            cpu: "500m"
            memory: "512Mi"
          } | {
            cpu?: string
            memory?: string
          }
        }


---
# VCluster Component (creates virtual Kubernetes environments)
apiVersion: core.oam.dev/v1beta1
kind: ComponentDefinition
metadata:
  name: vcluster
  annotations:
    definition.oam.dev/description: "Virtual Kubernetes cluster with optional components via Crossplane"
spec:
  workload:
    definition:
      apiVersion: platform.example.org/v1alpha1
      kind: VClusterEnvironmentClaim
  schematic:
    cue:
      template: |
        output: {
          apiVersion: "platform.example.org/v1alpha1"
          kind: "VClusterEnvironmentClaim"
          metadata: {
            name: parameter.name
            namespace: context.namespace
          }
          spec: {
            name: parameter.name
            if parameter.domain != _|_ {
              domain: parameter.domain
            }
            components: {
              istio: parameter.istio
              knativeServing: parameter.knativeServing
              argoCD: parameter.argoCD
              if parameter.observability {
                grafana: true
                prometheus: true
                jaeger: true
                kiali: true
              }
              if parameter.apiGateway {
                apiGateway: true
              }
            }
          }
        }
        
        parameter: {
          // Required
          name: string
          
          // Optional
          domain?: string
          istio: *true | bool
          knativeServing: *true | bool
          argoCD: *true | bool
          observability: *true | bool
          apiGateway: *false | bool
        }

---
# External Integration Components

# Neon Postgres Component (managed database via Secret reference)
apiVersion: core.oam.dev/v1beta1
kind: ComponentDefinition
metadata:
  name: neon-postgres
  annotations:
    definition.oam.dev/description: "Neon PostgreSQL managed database credentials via Secret reference"
spec:
  workload:
    definition:
      apiVersion: v1
      kind: Secret
  schematic:
    cue:
      template: |
        output: {
          apiVersion: "v1"
          kind: "Secret"
          metadata: {
            name: parameter.name + "-db-credentials" 
            namespace: context.namespace
            annotations: {
              // Multi-cluster deployment support
              if parameter.targetEnvironment != _|_ {
                "app.oam.dev/cluster": parameter.targetEnvironment
              }
              "neon-postgres.oam.dev/source-secret": "neon-postgres-credentials"
              "neon-postgres.oam.dev/component-scoped": "true"
            }
          }
          type: "Opaque"
          stringData: {
            PGDATABASE: parameter.database
            // Component references host secret via external mechanism
            DB_REF: "host-cluster"
          }
        }
        
        parameter: {
          // Required
          name: string
          
          // Optional
          database: *"postgres" | string
          targetEnvironment?: string  // vCluster deployment target
        }

---
# Auth0 Identity Provider Component
apiVersion: core.oam.dev/v1beta1
kind: ComponentDefinition
metadata:
  name: auth0-idp
  annotations:
    definition.oam.dev/description: "Auth0 identity provider integration via External Secrets"
spec:
  workload:
    definition:
      apiVersion: external-secrets.io/v1beta1
      kind: ExternalSecret
  schematic:
    cue:
      template: |
        output: {
          apiVersion: "external-secrets.io/v1beta1"
          kind: "ExternalSecret"
          metadata: {
            name: parameter.name + "-auth0-credentials"
            namespace: context.namespace
            // Multi-cluster deployment support
            if parameter.targetEnvironment != _|_ {
              annotations: {
                "app.oam.dev/cluster": parameter.targetEnvironment
              }
            }
          }
          spec: {
            refreshInterval: "1h"
            secretStoreRef: {
              kind: "ClusterSecretStore"
              name: "aws-secretsmanager"
            }
            target: {
              name: parameter.name + "-auth0-credentials"
              creationPolicy: "Owner"
            }
            data: [
              {
                secretKey: "clientId"
                remoteRef: {
                  key: "auth0/credentials"
                  property: "clientId"
                }
              },
              {
                secretKey: "clientSecret"
                remoteRef: {
                  key: "auth0/credentials"
                  property: "clientSecret"
                }
              },
              {
                secretKey: "domain"
                remoteRef: {
                  key: "auth0/credentials"
                  property: "domain"
                }
              },
              {
                secretKey: "audience"
                remoteRef: {
                  key: "auth0/credentials"  
                  property: "audience"
                }
              }
            ]
          }
        }
        
        parameter: {
          // Required
          name: string
          
          // Optional
          targetEnvironment?: string  // vCluster deployment target
        }

---
# ClickHouse Analytics Database ComponentDefinition
# Optimized for healthcare analytics and time-series data
# Supports OLAP queries for demand forecasting and reporting
apiVersion: core.oam.dev/v1beta1
kind: ComponentDefinition
metadata:
  name: clickhouse
  annotations:
    definition.oam.dev/description: "ClickHouse analytical database for time-series data and OLAP queries with healthcare compliance"
spec:
  workload:
    definition:
      apiVersion: helm.crossplane.io/v1beta1
      kind: Release
  schematic:
    cue:
      template: |
        output: {
          apiVersion: "helm.crossplane.io/v1beta1"
          kind: "Release"
          metadata: {
            name: parameter.name + "-clickhouse"
            namespace: context.namespace
            labels: {
              "app.kubernetes.io/name": parameter.name + "-clickhouse"
              "app.kubernetes.io/component": "analytics-database"
              "app.kubernetes.io/managed-by": "kubevela"
            }
            // Multi-cluster deployment support
            if parameter.targetEnvironment != _|_ {
              annotations: {
                "app.oam.dev/cluster": parameter.targetEnvironment
              }
            }
          }
          spec: {
            forProvider: {
              chart: {
                name: "clickhouse"
                repository: "https://charts.bitnami.com/bitnami"
                version: "4.1.15"
              }
              namespace: context.namespace
              skipCreateNamespace: false
              values: {
                architecture: parameter.architecture
                auth: {
                  username: parameter.auth.username
                  password: parameter.auth.password
                  database: parameter.auth.database
                }
                persistence: {
                  enabled: true
                  size: parameter.storage
                  storageClass: parameter.storageClass
                }
                resources: {
                  requests: {
                    cpu: parameter.resources.cpu
                    memory: parameter.resources.memory
                  }
                  limits: {
                    cpu: parameter.resources.cpu
                    memory: parameter.resources.memory
                  }
                }
                if parameter.architecture == "replication" {
                  replicaCount: parameter.replicas
                  shards: parameter.shards
                }
                service: {
                  type: "ClusterIP"
                  ports: {
                    http: 8123
                    tcp: 9000
                    mysql: 9004
                    postgresql: 9005
                  }
                }
                configuration: {
                  // Healthcare-specific optimizations
                  maxMemoryUsage: "8000000000"  // 8GB for analytics queries
                  maxBytesBeforeExternalGroupBy: "2000000000"  // 2GB
                  maxBytesBeforeExternalSort: "2000000000"     // 2GB
                  httpPort: 8123
                  tcpPort: 9000
                  // Timezone for South African operations
                  timezone: "Africa/Johannesburg"
                  // Custom settings for healthcare compliance
                  queryLogRetentionTime: "7776000"  // 90 days for audit compliance
                  partLogRetentionTime: "7776000"   // 90 days
                  // Performance optimizations for stock analytics
                  backgroundPoolSize: 16
                  backgroundSchedulePoolSize: 16
                  maxConcurrentQueries: 100
                  maxConnections: 1000
                }
                metrics: {
                  enabled: true
                  serviceMonitor: {
                    enabled: true
                  }
                }
                // Healthcare data encryption
                tls: {
                  enabled: parameter.security.tlsEnabled
                  if parameter.security.tlsEnabled {
                    certificatesSecret: parameter.security.certificateSecret
                  }
                }
                // Backup configuration for compliance
                backup: {
                  enabled: parameter.backup.enabled
                  if parameter.backup.enabled {
                    schedule: parameter.backup.schedule
                    retention: parameter.backup.retentionDays
                  }
                }
                // Network policies for healthcare security
                networkPolicy: {
                  enabled: parameter.security.networkPolicyEnabled
                  if parameter.security.networkPolicyEnabled {
                    allowExternal: false
                    ingressRules: {
                      accessOnlyFrom: {
                        enabled: true
                        namespaceSelector: {
                          "healthcare.org/access": "analytics"
                        }
                      }
                    }
                  }
                }
              }
            }
            providerConfigRef: {
              name: "default"
            }
          }
        }
        
        parameter: {
          // Required
          name: string
          
          // Database configuration
          auth: *{
            username: "clickhouse"
            password: "secure-clickhouse-password"
            database: "healthcare_analytics"
          } | {
            username: string
            password: string
            database: string
          }
          
          // Infrastructure configuration
          architecture: *"standalone" | "replication"
          replicas: *1 | int
          shards: *1 | int
          storage: *"20Gi" | string
          storageClass: *"gp2" | string
          
          // Resource allocation
          resources: *{
            cpu: "2000m"
            memory: "4Gi"
          } | {
            cpu: string
            memory: string
          }
          
          // Security configuration
          security: *{
            tlsEnabled: true
            networkPolicyEnabled: true
            certificateSecret: "clickhouse-tls-cert"
          } | {
            tlsEnabled: bool
            networkPolicyEnabled?: bool
            certificateSecret?: string
          }
          
          // Backup configuration for healthcare compliance
          backup: *{
            enabled: true
            schedule: "0 2 * * *"  // Daily at 2 AM
            retentionDays: 2555    // 7 years for healthcare compliance
          } | {
            enabled: bool
            schedule?: string
            retentionDays?: int
          }
          targetEnvironment?: string  // vCluster deployment target
        }

---
# Rasa Chatbot ComponentDefinition
# Architecturally follows realtime-platform pattern: OAM Component â†’ Dual Knative Services + Optional Infrastructure
apiVersion: core.oam.dev/v1beta1
kind: ComponentDefinition
metadata:
  name: rasa-chatbot
  annotations:
    definition.oam.dev/description: "Complete Rasa chatbot with dual-container pattern (Rasa server + Actions server) and automatic service discovery"
spec:
  workload:
    definition:
      apiVersion: serving.knative.dev/v1
      kind: Service
    type: services.serving.knative.dev
  schematic:
    cue:
      template: |
        // Primary Output: Rasa Server Knative Service (OAM-compliant workload)
        output: {
          apiVersion: "serving.knative.dev/v1"
          kind: "Service"
          metadata: {
            name: context.name + "-rasa"
            namespace: context.namespace
            labels: {
              "app.kubernetes.io/name": context.name
              "app.kubernetes.io/component": "rasa-server"
              "app.kubernetes.io/managed-by": "kubevela"
              "app.kubernetes.io/part-of": "rasa-chatbot"
            }
            annotations: {
              // Multi-cluster deployment support
              if parameter.targetEnvironment != _|_ {
                "app.oam.dev/cluster": parameter.targetEnvironment
              }
              "rasa-chatbot.oam.dev/bootstrap": "true"
              "rasa-chatbot.oam.dev/actions-service": context.name + "-actions"
              "rasa-chatbot.oam.dev/component-type": "rasa-server"
            }
          }
          spec: {
            template: {
              metadata: {
                annotations: {
                  "autoscaling.knative.dev/minScale": "\(parameter.minScale)"
                  "autoscaling.knative.dev/maxScale": "\(parameter.maxScale)"
                  if parameter.targetConcurrency != _|_ {
                    "autoscaling.knative.dev/target": "\(parameter.targetConcurrency)"
                  }
                  "run.googleapis.com/execution-environment": "gen2"
                }
                labels: {
                  "app.kubernetes.io/name": context.name
                  "app.kubernetes.io/version": parameter.version
                  "app.kubernetes.io/part-of": "rasa-chatbot"
                }
              }
              spec: {
                serviceAccountName: "knative-docker-sa"
                containers: [{
                  image: parameter.rasaImage
                  ports: [{
                    containerPort: 5005
                    name: "http1"
                  }]
                  resources: {
                    limits: {
                      cpu: parameter.resources.cpu
                      memory: parameter.resources.memory
                    }
                    requests: {
                      cpu: "250m"
                      memory: "512Mi"
                    }
                  }
                  env: [
                    {
                      name: "RASA_ACTION_ENDPOINT"
                      value: "http://" + context.name + "-actions." + context.namespace + ".svc.cluster.local:5055/webhook"
                    },
                    {
                      name: "ACTIONS_SERVER_HOST"
                      value: context.name + "-actions." + context.namespace + ".svc.cluster.local"
                    },
                    {
                      name: "ACTIONS_SERVER_PORT"
                      value: "5055"
                    },
                    {
                      name: "ACTION_ENDPOINT_URL"
                      value: "http://" + context.name + "-actions." + context.namespace + ".svc.cluster.local:5055/webhook"
                    },
                    {
                      name: "RASA_WEBHOOK_URL"
                      value: "http://" + context.name + "-rasa." + context.namespace + ".svc.cluster.local:5005/webhooks/rest/webhook"
                    },
                    {
                      name: "AGENT_TYPE"
                      value: "rasa-chatbot"
                    },
                    {
                      name: "LOG_LEVEL"
                      value: "INFO"
                    },
                    {
                      name: "RASA_TELEMETRY_ENABLED"
                      value: "false"
                    }
                  ] + [
                    for k, v in parameter.environment {
                      name: k
                      value: v
                    }
                  ]
                  if parameter.envFrom != _|_ {
                    envFrom: parameter.envFrom
                  }
                  // Health checks for robust deployment
                  livenessProbe: {
                    httpGet: {
                      path: "/api/status"
                      port: 5005
                    }
                    initialDelaySeconds: 30
                    periodSeconds: 10
                  }
                  readinessProbe: {
                    httpGet: {
                      path: "/api/status"
                      port: 5005
                    }
                    initialDelaySeconds: 5
                    periodSeconds: 5
                  }
                }]
              }
            }
          }
        }
        
        // Secondary Outputs: Actions Server + Optional Infrastructure
        outputs: {
          // Actions Server Knative Service (always created)
          "actions-server": {
            apiVersion: "serving.knative.dev/v1"
            kind: "Service"
            metadata: {
              name: context.name + "-actions"
              namespace: context.namespace
              labels: {
                "app.kubernetes.io/name": context.name
                "app.kubernetes.io/component": "actions-server"
                "app.kubernetes.io/managed-by": "kubevela"
                "app.kubernetes.io/part-of": "rasa-chatbot"
              }
              annotations: {
                // Multi-cluster deployment support
                if parameter.targetEnvironment != _|_ {
                  "app.oam.dev/cluster": parameter.targetEnvironment
                }
                "rasa-chatbot.oam.dev/component-type": "actions-server"
                "rasa-chatbot.oam.dev/rasa-service": context.name + "-rasa"
              }
            }
            spec: {
              template: {
                metadata: {
                  annotations: {
                    "autoscaling.knative.dev/minScale": "\(parameter.actionsMinScale)"
                    "autoscaling.knative.dev/maxScale": "\(parameter.actionsMaxScale)"
                    if parameter.actionsTargetConcurrency != _|_ {
                      "autoscaling.knative.dev/target": "\(parameter.actionsTargetConcurrency)"
                    }
                    "run.googleapis.com/execution-environment": "gen2"
                  }
                  labels: {
                    "app.kubernetes.io/name": context.name
                    "app.kubernetes.io/version": parameter.version
                    "app.kubernetes.io/part-of": "rasa-chatbot"
                  }
                }
                spec: {
                  serviceAccountName: "knative-docker-sa"
                  containers: [{
                    image: parameter.actionsImage
                    ports: [{
                      containerPort: 5055
                      name: "http1"
                    }]
                    resources: {
                      limits: {
                        cpu: parameter.actionsResources.cpu
                        memory: parameter.actionsResources.memory
                      }
                      requests: {
                        cpu: "100m"
                        memory: "256Mi"
                      }
                    }
                    env: [
                      {
                        name: "RASA_URL"
                        value: "http://" + context.name + "-rasa." + context.namespace + ".svc.cluster.local:5005"
                      },
                      {
                        name: "RASA_WEBHOOK_URL"
                        value: "http://" + context.name + "-rasa." + context.namespace + ".svc.cluster.local:5005/webhooks/rest/webhook"
                      },
                      {
                        name: "AGENT_TYPE"
                        value: "rasa-actions"
                      },
                      {
                        name: "LOG_LEVEL"
                        value: "INFO"
                      },
                      {
                        name: "PYTHONUNBUFFERED"
                        value: "1"
                      }
                    ] + [
                      for k, v in parameter.environment {
                        name: k
                        value: v
                      }
                    ]
                    if parameter.envFrom != _|_ {
                      envFrom: parameter.envFrom
                    }
                    // Health checks for robust deployment
                    livenessProbe: {
                      httpGet: {
                        path: "/health"
                        port: 5055
                      }
                      initialDelaySeconds: 30
                      periodSeconds: 10
                    }
                    readinessProbe: {
                      httpGet: {
                        path: "/health"
                        port: 5055
                      }
                      initialDelaySeconds: 5
                      periodSeconds: 5
                    }
                  }]
                }
              }
            }
          }
        }
        
        // Repository Creation Workflow (conditional - same pattern as webservice and realtime-platform)
        if parameter.language != _|_ {
          outputs: {
            // Always include actions server
            "actions-server": outputs["actions-server"]
            
            // Add workflow trigger when language specified
            "workflow-trigger": {
              apiVersion: "batch/v1"
              kind: "Job"
              metadata: {
                name: context.name + "-workflow-trigger"
                namespace: context.namespace
                labels: {
                  "app.kubernetes.io/name": context.name
                  "app.kubernetes.io/component": "workflow-trigger"
                  "app.kubernetes.io/managed-by": "kubevela"
                  "app.kubernetes.io/part-of": "rasa-chatbot"
                }
                annotations: {
                  "rasa-chatbot.oam.dev/trigger-type": "argo-workflow"
                  "rasa-chatbot.oam.dev/workflow-template": "microservice-standard-contract"
                  "rasa-chatbot.oam.dev/source": "oam-driven"
                  "rasa-chatbot.oam.dev/platform-type": "chatbot"
                }
              }
              spec: {
                template: {
                  spec: {
                    serviceAccountName: "argo-workflows-client"
                    restartPolicy: "Never"
                    volumes: [
                      {
                        name: "argo-token"
                        secret: {
                          secretName: "slack-api-argo-token-copy"
                        }
                      }
                    ]
                    containers: [{
                      name: "workflow-trigger"
                      image: "curlimages/curl:7.85.0"
                      command: ["sh", "-c"]
                      args: [
                        """
                        echo "Triggering Argo Workflow for Rasa chatbot repository creation..."
                        echo "Service: $(SERVICE_NAME)"
                        echo "Language: $(LANGUAGE)"
                        echo "Framework: $(FRAMEWORK)"
                        echo "Repository: $(REPOSITORY)"
                        
                        # Create parameters for Argo Workflows
                        cat > /tmp/workflow-params.json << EOF
                        {
                          "serviceName": "$(SERVICE_NAME)",
                          "language": "$(LANGUAGE)",
                          "framework": "$(FRAMEWORK)",
                          "repository": "$(REPOSITORY)",
                          "appContainer": "$(REPOSITORY)",
                          "platformType": "chatbot",
                          "sourceType": "oam-driven",
                          "chatbotType": "rasa"
                        }
                        EOF
                        
                        echo "Workflow parameters:"
                        cat /tmp/workflow-params.json
                        
                        # Submit to Argo Workflows
                        curl -X POST \
                          -H "Authorization: Bearer $(cat /var/run/secrets/argo-token/token)" \
                          -H "Content-Type: application/json" \
                          -d @/tmp/workflow-params.json \
                          "http://argo-workflows-server.argo.svc.cluster.local:2746/api/v1/workflows/argo/submit" \
                          --connect-timeout 30 \
                          --max-time 60 \
                          --retry 3 \
                          --fail \
                          || echo "Workflow submission failed, but continuing..."
                        
                        echo "Rasa chatbot workflow trigger completed"
                        """
                      ]
                      env: [
                        {
                          name: "SERVICE_NAME"
                          value: context.name
                        },
                        {
                          name: "LANGUAGE"
                          value: parameter.language
                        },
                        {
                          name: "FRAMEWORK"
                          value: parameter.framework
                        },
                        {
                          name: "REPOSITORY"
                          value: (*parameter.repository | context.name)
                        }
                      ]
                      volumeMounts: [
                        {
                          name: "argo-token"
                          mountPath: "/var/run/secrets/argo-token"
                          readOnly: true
                        }
                      ]
                    }]
                  }
                }
              }
            }
          }
        }
        
        parameter: {
          // Required (following realtime-platform pattern)
          rasaImage: string
          actionsImage: string
          
          // Service Configuration  
          version: *"latest" | string
          
          // Resource Management (Rasa Server)
          resources: *{
            cpu: "500m"
            memory: "1Gi"
          } | {
            cpu?: string
            memory?: string
          }
          
          // Resource Management (Actions Server)
          actionsResources: *{
            cpu: "250m"
            memory: "512Mi"
          } | {
            cpu?: string
            memory?: string
          }
          
          // Scaling Configuration (Rasa Server)
          minScale: *1 | int
          maxScale: *10 | int
          targetConcurrency?: int
          
          // Scaling Configuration (Actions Server)
          actionsMinScale: *0 | int
          actionsMaxScale: *5 | int
          actionsTargetConcurrency?: int
          
          // Environment Variables
          environment: *{} | {[string]: string}
          
          // Environment Variables from Secrets
          envFrom?: [...{
            secretRef: {
              name: string
            }
          }]
          
          // Optional Infrastructure Bootstrap (for repository creation equivalence)
          language?: string     // Triggers bootstrap: rasa
          framework?: string    // chatbot
          repository?: string   // Git repository template name (defaults to name)
          
          // External Access Configuration (optional)
          enableIstioGateway?: bool
          chatbotHost?: string
          enableTLS?: bool
          
          targetEnvironment?: string  // vCluster deployment target
        }

